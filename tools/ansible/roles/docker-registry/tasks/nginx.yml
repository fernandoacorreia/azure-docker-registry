# Installs nginx in a Docker container.
---
- name: create nginx tools directory
  file: path=/opt/nginx state=directory

- name: copy nginx tools
  copy: src=nginx/ dest=/opt/nginx

- name: create nginx image directory
  file: path=/tmp/nginx-image state=directory

- name: copy nginx container image files
  copy: src=nginx-image/{{item}} dest=/tmp/nginx-image
  with_items:
    - Dockerfile
    - nginx-run
    - nginx.conf

- name: copy nginx container image templates
  template: src=nginx-image/{{item}} dest=/tmp/nginx-image
  with_items:
    - http-443.conf
    - http-80.conf

- name: copy password file # This file is dynamically generated by the setup script.
  copy: src=/tmp/docker-registry.htpasswd dest=/tmp/nginx-image/docker-registry.htpasswd owner=root group=root mode=0600

- name: copy certificate
  copy: src=/mnt/tmp/docker-registry/ssl.crt dest=/tmp/nginx-image/ssl.crt owner=root group=root mode=0600

- name: copy certificate key
  copy: src=/mnt/tmp/docker-registry/ssl.key dest=/tmp/nginx-image/ssl.key owner=root group=root mode=0600

- name: create nginx container ssh key
  shell: creates=/home/{{user}}/.ssh/nginx-container mkdir -p /home/{{user}}/.ssh && ssh-keygen -t rsa -P "" -f /home/{{user}}/.ssh/nginx-container && chown "{{user}}:" /home/{{user}}/.ssh/nginx-container* && chmod 0600 /home/{{user}}/.ssh/nginx-container*

- name: copy private nginx ssh key to root
  shell: mkdir -p /root/.ssh && cp /home/{{user}}/.ssh/nginx-container /root/.ssh/ && chown "root:root" /root/.ssh/nginx-container

- name: copy public nginx ssh key to container image
  command: cp /home/{{user}}/.ssh/nginx-container.pub /tmp/nginx-image/nginx-container.pub

- name: build nginx container image
  command: docker build --rm --tag="docker_registry_nginx_image" /tmp/nginx-image

- name: remove temporary nginx image files
  shell: rm -rf /tmp/nginx-image

- name: create nginx container
  command: /opt/nginx/create-nginx-container
